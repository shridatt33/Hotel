<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0891b2">
    <title>Menu - Table {{ table.table_number }} - HotelEase</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='table_menu.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1><i class="fas fa-utensils"></i> Restaurant Menu</h1>
        <div class="table-info">
            <i class="fas fa-chair"></i> Table {{ table.table_number }}
        </div>
    </header>

    <!-- Category Navigation -->
    <nav class="category-nav" id="category-nav" style="display: none;">
        <div class="category-tabs" id="category-tabs">
            <!-- Populated by JavaScript -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="menu-container" id="menu-container">
        {% if table_busy %}
        <div class="table-busy-notice">
            <i class="fas fa-info-circle"></i>
            <div>
                <h3>Table is currently busy</h3>
                <p>If you already placed an order on this visit, you can still add more items. Otherwise, please wait for the current order to finish.</p>
            </div>
        </div>
        {% endif %}
        
        <div class="loading" id="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading menu...</p>
        </div>
    </main>

    <!-- Cart Bar (Sticky Bottom) -->
    <div class="cart-bar" id="cart-bar">
        <div class="cart-bar-content">
            <div class="cart-summary">
                <div class="cart-items-count" id="cart-items-count">0 items</div>
                <div class="cart-total" id="cart-total">₹0.00</div>
            </div>
            <button class="place-order-btn" onclick="placeOrder()">
                <i class="fas fa-shopping-bag"></i>
                <span>Place Order</span>
            </button>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div class="order-modal" id="order-modal">
        <div class="order-modal-content">
            <div class="order-success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3>Order Placed!</h3>
            <p>Your order is being prepared</p>
            <div class="order-id" id="modal-order-id">Order #123</div>
            <button class="btn" onclick="closeModal()">Continue Browsing</button>
        </div>
    </div>

    <script>
        const tableId = {{ table.id }};
        const sessionStorageKey = `table_session_${tableId}`;
        let cart = [];
        let currentOrderId = null;
        let sessionId = localStorage.getItem(sessionStorageKey);
        let menuData = [];
        
        // Load menu on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMenu();
        });
        
        function loadMenu() {
            fetch('/api/public-menu/' + tableId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        menuData = data.menu;
                        renderCategoryNav(data.menu);
                        renderMenu(data.menu);
                    } else {
                        showError(data.message || 'Error loading menu');
                    }
                })
                .catch(error => {
                    console.error('Error loading menu:', error);
                    showError('Failed to load menu. Please try again.');
                });
        }
        
        function showError(message) {
            const container = document.getElementById('menu-container');
            container.innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function renderCategoryNav(menu) {
            const nav = document.getElementById('category-nav');
            const tabs = document.getElementById('category-tabs');
            
            if (menu.length === 0) return;
            
            let tabsHTML = '';
            menu.forEach((category, index) => {
                if (category.dishes.length > 0) {
                    tabsHTML += `
                        <button class="category-tab ${index === 0 ? 'active' : ''}" 
                                onclick="scrollToCategory('category-${category.category_id}', this)">
                            ${category.category_name}
                            <span class="count">${category.dishes.length}</span>
                        </button>
                    `;
                }
            });
            
            tabs.innerHTML = tabsHTML;
            nav.style.display = 'block';
        }
        
        function scrollToCategory(categoryId, btn) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Scroll to category
            const element = document.getElementById(categoryId);
            if (element) {
                const navHeight = document.getElementById('category-nav').offsetHeight;
                const headerHeight = document.querySelector('.header').offsetHeight;
                const offset = headerHeight + navHeight + 16;
                
                window.scrollTo({
                    top: element.offsetTop - offset,
                    behavior: 'smooth'
                });
            }
        }
        
        function renderMenu(menu) {
            const container = document.getElementById('menu-container');
            const loadingState = document.getElementById('loading-state');
            
            if (loadingState) loadingState.remove();
            
            if (menu.length === 0 || !menu.some(c => c.dishes.length > 0)) {
                container.innerHTML += `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <h3>No menu items available</h3>
                        <p>Please check back later</p>
                    </div>
                `;
                return;
            }
            
            let menuHTML = '';
            
            menu.forEach(category => {
                if (category.dishes.length > 0) {
                    menuHTML += `
                        <div class="category" id="category-${category.category_id}">
                            <div class="category-header">
                                <h2><i class="fas fa-bowl-food"></i> ${category.category_name}</h2>
                                <span class="category-count">${category.dishes.length} items</span>
                            </div>
                            <div class="menu-items">
                    `;
                    
                    category.dishes.forEach(dish => {
                        const cartItem = cart.find(item => item.name === dish.name);
                        const quantity = cartItem ? cartItem.quantity : 0;
                        
                        menuHTML += renderDishCard(dish, quantity);
                    });
                    
                    menuHTML += '</div></div>';
                }
            });
            
            // Preserve the table-busy-notice if it exists
            const notice = container.querySelector('.table-busy-notice');
            container.innerHTML = (notice ? notice.outerHTML : '') + menuHTML;
        }
        
        function renderDishCard(dish, quantity) {
            const imageHTML = dish.image_urls && dish.image_urls.length > 0 
                ? `<img src="${dish.image_urls[0]}" alt="${dish.name}" loading="lazy">`
                : '<div class="no-image"><i class="fas fa-image"></i></div>';
            
            const escapedName = dish.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            
            const actionHTML = quantity > 0 
                ? `
                    <div class="quantity-controls" id="qty-${escapedName.replace(/\s+/g, '-')}">
                        <button class="qty-btn minus" onclick="updateQuantity('${escapedName}', -1)">−</button>
                        <span class="qty-value">${quantity}</span>
                        <button class="qty-btn plus" onclick="updateQuantity('${escapedName}', 1)">+</button>
                    </div>
                `
                : `
                    <button class="add-btn" onclick="addToCart('${escapedName}', ${dish.price})">
                        <i class="fas fa-plus"></i> Add
                    </button>
                `;
            
            return `
                <div class="menu-item" data-dish="${escapedName}">
                    <div class="item-image">
                        ${imageHTML}
                    </div>
                    <div class="item-details">
                        <div class="item-name">${dish.name}</div>
                        ${dish.description ? `<div class="item-description">${dish.description}</div>` : ''}
                        <div class="item-quantity-info">${dish.quantity}</div>
                        <div class="item-footer">
                            <div class="item-price">₹${dish.price.toFixed(2)}</div>
                            ${actionHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addToCart(itemName, price) {
            const existingItem = cart.find(item => item.name === itemName);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    name: itemName,
                    price: price,
                    quantity: 1
                });
            }
            
            updateCartUI();
            updateDishButton(itemName);
            
            // Pulse animation on cart
            const cartBar = document.getElementById('cart-bar');
            cartBar.classList.add('pulse');
            setTimeout(() => cartBar.classList.remove('pulse'), 500);
        }
        
        function updateQuantity(itemName, delta) {
            const item = cart.find(i => i.name === itemName);
            if (!item) return;
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                cart = cart.filter(i => i.name !== itemName);
            }
            
            updateCartUI();
            updateDishButton(itemName);
        }
        
        function updateDishButton(itemName) {
            const dish = menuData.flatMap(c => c.dishes).find(d => d.name === itemName);
            if (!dish) return;
            
            const menuItem = document.querySelector(`.menu-item[data-dish="${itemName.replace(/'/g, "\\'")}"]`);
            if (!menuItem) return;
            
            const footer = menuItem.querySelector('.item-footer');
            const cartItem = cart.find(item => item.name === itemName);
            const quantity = cartItem ? cartItem.quantity : 0;
            
            const escapedName = itemName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            
            const actionHTML = quantity > 0 
                ? `
                    <div class="quantity-controls">
                        <button class="qty-btn minus" onclick="updateQuantity('${escapedName}', -1)">−</button>
                        <span class="qty-value">${quantity}</span>
                        <button class="qty-btn plus" onclick="updateQuantity('${escapedName}', 1)">+</button>
                    </div>
                `
                : `
                    <button class="add-btn" onclick="addToCart('${escapedName}', ${dish.price})">
                        <i class="fas fa-plus"></i> Add
                    </button>
                `;
            
            footer.innerHTML = `
                <div class="item-price">₹${dish.price.toFixed(2)}</div>
                ${actionHTML}
            `;
        }
        
        function updateCartUI() {
            const cartBar = document.getElementById('cart-bar');
            const itemsCount = document.getElementById('cart-items-count');
            const cartTotal = document.getElementById('cart-total');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (totalItems > 0) {
                itemsCount.textContent = `${totalItems} item${totalItems > 1 ? 's' : ''}`;
                cartTotal.textContent = `₹${totalPrice.toFixed(2)}`;
                cartBar.classList.add('show');
            } else {
                cartBar.classList.remove('show');
            }
        }
        
        function placeOrder() {
            if (cart.length === 0) {
                alert('Please add items to your order first!');
                return;
            }
            
            if (!confirm('Confirm your order?')) {
                return;
            }
            
            // Show loading state on button
            const btn = document.querySelector('.place-order-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;
            
            fetch('/orders/api/create-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    table_id: tableId,
                    items: cart,
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                
                if (data.success) {
                    currentOrderId = data.order_id;
                    if (data.session_id) {
                        sessionId = data.session_id;
                        localStorage.setItem(sessionStorageKey, sessionId);
                    }
                    
                    // Show success modal
                    showOrderModal(currentOrderId);
                    
                    // Reset cart
                    cart = [];
                    updateCartUI();
                    
                    // Re-render menu to reset buttons
                    renderMenu(menuData);
                } else {
                    alert('Error placing order: ' + data.message);
                }
            })
            .catch(error => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                console.error('Error placing order:', error);
                alert('Error placing order. Please try again.');
            });
        }
        
        function showOrderModal(orderId) {
            const modal = document.getElementById('order-modal');
            const orderIdEl = document.getElementById('modal-order-id');
            orderIdEl.textContent = `Order #${orderId}`;
            modal.classList.add('show');
        }
        
        function closeModal() {
            const modal = document.getElementById('order-modal');
            modal.classList.remove('show');
        }
        
        // Close modal on outside click
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Intersection Observer for category nav highlighting
        function setupScrollSpy() {
            const categories = document.querySelectorAll('.category');
            const tabs = document.querySelectorAll('.category-tab');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        tabs.forEach(tab => {
                            tab.classList.toggle('active', 
                                tab.getAttribute('onclick').includes(id));
                        });
                    }
                });
            }, {
                rootMargin: '-150px 0px -50% 0px',
                threshold: 0
            });
            
            categories.forEach(cat => observer.observe(cat));
        }
        
        // Initialize scroll spy after menu loads
        const originalRenderMenu = renderMenu;
        renderMenu = function(menu) {
            originalRenderMenu(menu);
            setTimeout(setupScrollSpy, 100);
        };
    </script>
</body>
</html>
